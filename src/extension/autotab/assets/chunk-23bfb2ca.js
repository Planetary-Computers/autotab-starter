var S=Object.defineProperty;var C=(t,e,s)=>e in t?S(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var c=(t,e,s)=>(C(t,typeof e!="symbol"?e+"":e,s),s);import{R as r,s as I,c as p,d as b,N as h,e as k,f as T,g as i,h as E,T as d,E as w,G as D,L as K,n as g,H as L,I as G,C as M,a as x,i as A,b as P,K as U}from"./chunk-f0ce9ccd.js";const Q=async(t,e)=>{const s=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!s.ok)throw new Error(`Server error: ${s.status}`);return(await s.json()).map(o=>({type:"codeGenResponse",...o}))},l=t=>{chrome.tabs.query({active:!0,currentWindow:!0},function(e){e[0]&&e[0].id!==void 0&&chrome.tabs.sendMessage(e[0].id,t)})};let N=r.NOT_RECORDING,O=!1;const y=t=>{N=t},a=()=>N,R=t=>{O=t},V=()=>O,W=t=>{},j=()=>!0,f=["Meta","Shift"];class Y{constructor(e){c(this,"keyQueue");c(this,"elementInteractionQueue");c(this,"tabQueue");c(this,"tabs");c(this,"currentTabId");c(this,"baseUrl");this.keyQueue=[],this.elementInteractionQueue=[],this.tabQueue=[],this.baseUrl=e,this.tabs={},this.currentTabId=""}async dumpLogToServer(){if(console.log("ActionQueue getIsLoggedIn():",j()),this.keyQueue.length===0&&this.elementInteractionQueue.length===0&&this.tabQueue.length===0)return;chrome.runtime.sendMessage(I);const e={keyQueue:this.keyQueue,elementInteractionQueue:this.elementInteractionQueue,tabQueue:this.tabQueue};this.keyQueue=[],this.elementInteractionQueue=[],this.tabQueue=[];try{const s=await Q(`${this.baseUrl}/code/generate`,e);for(const n of s){const o={type:p,newCodeGenState:b.CODE_GENERATED,codeGenResponse:n};chrome.runtime.sendMessage(o)}}catch(s){const n={type:p,newCodeGenState:b.FAILED,error:s instanceof Error?s.message:JSON.stringify(s)};chrome.runtime.sendMessage(n)}}_broadcastRecordingStateUpdate(e){y(e.newRecordingState),l(e),chrome.runtime.sendMessage(e)}toggleRecording(){if(console.log("toggleRecording, current state:",a()),a()===r.RECORDING){this.dumpLogToServer();const e={type:h,newRecordingState:r.NOT_RECORDING};this._broadcastRecordingStateUpdate(e)}else{const e={type:h,newRecordingState:r.RECORDING};this._broadcastRecordingStateUpdate(e)}}toggleSelectElement(){if(a()===r.RECORDING_SELECT_ELEMENT){const e={type:h,newRecordingState:r.NOT_RECORDING};this._broadcastRecordingStateUpdate(e)}else{a()===r.RECORDING&&this.dumpLogToServer();const e={type:h,newRecordingState:r.RECORDING_SELECT_ELEMENT};this._broadcastRecordingStateUpdate(e)}}handleKeyDown(e){if(console.log("actionQueue key-down key:",e.key,"meta:",e.metaKey,"ctrl:",e.ctrlKey,"keyQueue:",this.keyQueue),console.log(a()),!f.includes(e.key)){if(e.key===k&&e.metaKey){console.log("KeyQueue: recording started"),this.toggleRecording();return}else if(e.key===T&&e.metaKey){console.log("KeyQueue: recording select element started"),this.toggleSelectElement();return}if(a()===r.RECORDING){const s=e.key;if(this.keyQueue.length>0){const n=this.keyQueue[this.keyQueue.length-1];if(n.key===s&&n.action===i.Down)return}this.keyQueue.push(new E(s,i.Down))}}}getCurrentKeysPressed(){return this.keyQueue.slice(-8).filter(n=>n.action===i.Down)}matchKeyDownIndex(e){const n=this.getCurrentKeysPressed().filter(o=>o.key===e);if(n.length>0){const o=this.keyQueue.lastIndexOf(n[n.length-1]);return this.keyQueue[o].action=i.Press,!0}return!1}handleKeyUp(e){if(console.log("actionQueue key-up key:",e.key,"meta:",e.metaKey,"ctrl:",e.ctrlKey,"keyQueue:",this.keyQueue),f.includes(e.key))return;if(e.key===k&&e.metaKey){console.log("KeyQueue: recording started"),this.toggleRecording();return}else if(e.key===T&&e.metaKey){console.log("KeyQueue: recording select element started"),this.toggleSelectElement();return}if(a()===r.NOT_RECORDING)return;if(this.keyQueue.length===0){e.key==="Enter"&&(this.keyQueue.push(new E(e.key,i.Press,e.tabId,e.url)),this.handleKeyTriggeredDump());return}if(this.keyQueue.findIndex(u=>u.key===e.key&&u.action===i.Down)===-1&&e.key!=="Enter")return;console.log("adding key up to keyQueue");const n=e.key;console.log("keyQueue length:",this.keyQueue.length);const o=n!=="Meta"&&this.matchKeyDownIndex(n);if(console.log("didMatch:",o,"key:",n,"key === Enter",n==="Enter"),n==="Enter"){console.log("enter key"),o?this.handleKeyTriggeredDump():(this.keyQueue.push(new E(n,i.Press,e.tabId,e.url)),this.handleKeyTriggeredDump());return}o||this.keyQueue.push(new E(n,i.Up,e.tabId,e.url))}hasKeys(){return this.keyQueue.length>0}_handleOpenTab(e,s){if(console.log("_handleOpenTab tabId:",e,"url:",s),this.tabs[e]===void 0){const n={id:e,index:Object.keys(this.tabs).length};console.log("new tab, initializing:",n),this.tabs[e]=n,n.index==0?this.tabQueue.push(new d(n.id,n.index,"load_url",s)):(this.tabQueue.push(new d(n.id,n.index,"open")),this.tabQueue.push(new d(n.id,n.index,"goto")),this.tabQueue.push(new d(n.id,n.index,"load_url",s))),this.currentTabId=n.id}else if(e!=this.currentTabId){console.log("tab change, enqueuing goto");const n=this.tabs[e];this.tabQueue.push(new d(n.id,n.index,"goto")),this.currentTabId=e}}handleKeyTriggeredDump(){const e=this.keyQueue[this.keyQueue.length-1];this._handleOpenTab(e.tabId,e.url),this.dumpLogToServer()}handleCloseTab(e){if(this.tabs[e]!==void 0){const s=this.tabs[e].index;this.tabQueue.push(new d(e,s,"close")),delete this.tabs[e];for(const n in this.tabs)this.tabs[n].index>s&&this.tabs[n].index--;this.dumpLogToServer()}}handleElementInteraction(e){this.elementInteractionQueue.push(new w(e)),this._handleOpenTab(e.tabId,e.url),this.dumpLogToServer()}handleOpenTab(e,s){this._handleOpenTab(e,s),this.dumpLogToServer()}}const m=new Y("https://api.autotab.com"),_=async t=>{if(console.log("handleElementInteraction"),a()===r.NOT_RECORDING){console.error("handleElementInteraction called even though is not recording");return}try{console.log("data:",t.DOM),m.handleElementInteraction(t)}catch(e){console.log("Error in chat completion:",e)}},q=async t=>{m.handleKeyDown(t.event)},B=async t=>{m.handleKeyUp(t.event)},J=async t=>{try{chrome.runtime.sendMessage(I),console.log("handling refine code event:",t);const e=await Q("https://api.autotab.com/code/refine",t);console.log("Code gen response received in refine code",e);for(const s of e){const n={type:p,newCodeGenState:b.CODE_GENERATED,codeGenResponse:{...s,blockOrder:t.blockOrder}};chrome.runtime.sendMessage(n)}}catch(e){console.log("Error in chat completion:",e)}};console.info("chrome-ext template-react-ts background script");chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0});chrome.runtime.onMessage.addListener((t,e,s)=>{if(console.log("background received message:",t,"sender:",e,"sendResponse:",s),!V())return!1;try{switch(t.type){case U:q(t);break;case P:B(t);break;case A:J(t);break;case x:_(t);break;case M:case G:case L:_(t),y(r.NOT_RECORDING),chrome.runtime.sendMessage(g),l(g);break;case K:console.log("backend received logged in event"),W(t.isLoggedIn),chrome.runtime.sendMessage(t),t.isLoggedIn||(y(r.NOT_RECORDING),chrome.runtime.sendMessage(g),l(g));break;case D:return chrome.tabs.query({active:!0,currentWindow:!0},function(n){const o=n[0].id,u=n[0].url;o&&u?s({tabId:o,url:u}):console.error("Could not get tabId or url from tabs",o,u)}),!0;case h:console.log("backend NEW_RECORDING_STATE_EVENT:",t.newRecordingState),y(t.newRecordingState),l(t);break;default:l(t),console.log("Ignoring message",t)}}catch(n){console.log("Error in background listener:",n)}return!0});chrome.runtime.onConnect.addListener(t=>{t.name==="mySidepanel"&&(chrome.storage.local.set({isSidePanelOpen:!0}),R(!0),t.onDisconnect.addListener(()=>{l(g),chrome.storage.local.set({isSidePanelOpen:!1}),R(!1)}))});chrome.tabs.onRemoved.addListener(t=>{m.handleCloseTab(t.toString())});chrome.tabs.onUpdated.addListener((t,e,s)=>{e.url&&console.log("tab change","id:",t,"index:",s.index,"changeInfo:",e)});
